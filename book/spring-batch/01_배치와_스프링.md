# 배치와 스프링  

- [학습 목표](#학습-목표)
- [배치 처리의 역사](#배치-처리의-역사)
- [배치가 직면한 과제](#배치가-직면한-과제)
- [왜 자바로 배치를 처리하는가?](#왜-자바로-배치를-처리하는가?)
- [스프링 배치의 기타 사용 사례](#스프링-배치의-기타-사용-사례)
- [스프링 배치 프레임워크](#스프링-배치-프레임워크)

## 학습 목표

- 배치 처리의 역사와 배치 처리에 대한 정의, 중요한 요소를 살펴봅니다.
- 왜 자바와 스프링 배치를 이용해야하는지 살펴봅니다.
- 스프링 배치의 사용 사례 및 간단한 아키텍처를 살펴봅니다.

---  

## 배치 처리의 역사  

:white_check_mark: 배치 처리?  

상호작용이나 중단 없이 유한한 양의 데이터를 처리하는 것으로 정의한다. 배치 처리가 일단 시작되면 아무런 개입 없이 어떤 형태로든 완료합니다.  

**Spring batch 1.0.0 ~ 4.0.0**  

- 2007년 액센츄어(Accenture)사는 자사의 풍부한 메인프레임 및 배치 처리 경험을 바탕으로 오픈소스 프레임워크 만들기위해 Interface21과 파트너십을 맺음
- 2008년 3월 말에 Spring batch 1.0.0 출시
- 2009년 4월 Spring batch 2.0.0 출시 (JDK 1.4 -> 1.5, 청크 기반 처리, 개선된 구성 옵션, 다양한 확장성 옵션 추가)
- 2014년 Spring batch 3.0.0에서 새로운 자바 배치 표준인 [JSR-352](https://docs.spring.io/spring-batch/docs/current/reference/html/jsr-352.html#jsr-352)를 구현
- Spring batch 4.0.0에서 Spring boot의 java-based configuration을 수용  

*:information_source: https://docs.spring.io/spring-batch/docs/ 에서 각 버젼별 문서를 확인할 수 있습니다.*  

---

## 배치가 직면한 과제  

소프트웨어 아키텍처는 공통적으로 사용성(usability), 유지 보수성(maintainability), 확장성(scalability) 등 여러 속성을 가지고 있다.  

배치 처리에서는 이러한 속성들이 기존 GUI 기반의 프로그래밍과 다른 측면으로 관련되어 있다.

**사용성(Usability), 유지 보수성(maintainability)**  
; 배치 처리에서 사용성은 코드에 관한 것을 의미한다, 즉 오류 처리 및 유지 보수성과 관련이 있다.  
- 공통 컴포넌트를 쉽게 확장해 새로운 기능을 추가할 수 있는가?
- 기존 컴포넌트를 변경할 때 시스템 전체에 미치는 영향을 알 수 있도록 단위 테스트가 잘 마련돼 있는가?
- 잡이 실패할 때 디버깅에 오랜 시간을 소비하지 않고 언제,어디서,왜 실패했는지 알 수 있는가?

**확장성(Scalability)**  
; 배치를 이용한 트랜잭션 처리가 8초 걸리면 10만 개의 트랜잭션을 처리하는 데 9일 이상(100만건의 경우 3개월)이 소요된다.  
(스프링 배치에서는 Scaling and Parallel Processing을 지원한다.)  

**가용성(availability)**  
; 배치 처리시에는 보통 약속이 정해져 있다. 필요한 리소스(하드웨어, 데이터 등)를 언제 사용할 수 있는지 알고 있는 상태에서 주어진 시간에 잡이 실행되도록 예약한다.  
아래와 같은 질문 외에 여러 다른 질문은 배치 시스템의 가용성에 영향을 준다.
- 필요할 때 바로 배치 처리를 수행할 수 있는가?
- 허용된 시간 내에 잡을 수행함으로써 다른 시스템에 영향을 미치지 않게 할 수 있는가?

**보안성**  
; 배치 처리에서 보안의 역할은 데이터를 안전하게 저장하는 것이다.  
- 민감한 데이터베이스 필드는 암호화돼 있는가?
- 실수로 개인 정보를 로그로 남기지 않는가?
- 외부 시스템으로의 접근은 어떠한가?
  - 자격증명이 필요하며 적절한 방식으로 보안을 유지하고 있는가?
- 데이터 유효성 검증도 보안의 일부

---  

## 왜 자바로 배치를 처리하는가?  

배치 처리 개발에 자바 및 오픈소스를 사용해야 하는 6가지 이유로 **유지 보수성**, **유연성**, **확장성**, **개발 리소스**, **지원**, **비용**을 생각할 수 있다.  

- 유지 보수성
  - 배치 처리 코드는 일반적으로 다른 애플리케이션 코드보다 수명이 훨씬 길다.
  - 스프링은 테스트 용이성(testability), 추상화(abstractions)와 같은 몇 가지 이점을 얻을 수 있도록 설계됐다.
    - 파일 및 데이터베이스 코드를 직접 작성하지 않고 사용이 가능하다.
    - 트랜잭션 및 커밋 횟수와 같은 것들을 직접 관리할 필요가 없다.
- 유연성
  - 애플리케이션 서버, 도커 컨테이너, 클라우드 등에 원하는 환경에 맞춰서 스프링 배치를 thin war, fat jar 등을 배포할 수 있다.
  - Spring batch는 시스템 간 코드를 공유할 수 있다. 
    - 웹 애플리케이션에서 이미 테스트 및 디버깅된 서비스를 배치에서 바로 이용할 수 있다.
- 확장성
  - 메인프레임
    - 병렬로 작업을 수행하는 유일한 방법은 단일 하드웨어 내에서 전체 프로그램을 병렬로 실행하는 것이다.
      - 병렬 처리용 관리 코드를 작성 / 유지 보수 해야 하며 이로 인해 오류 처리나 플랫폼 간 상태 관리 등에 어려움이 발생한다.
  - 커스텀 처리
    - 자바를 사용하더라도 처음부터 대량 데이터 처리에 적합한 확장성과 안정성을 얻기는 매우 어렵다.
      - 인프라스트럭처가 복잡해지고 분산 환경에 대한 통신 고민도 해야한다. 또는 특정 워커가 실패한 경우 등도 고려해야하고 많은 준비가 필요하다.
  - 자바와 스프링 배치
    - 스프링 배치를 이용하여 위의 문제를 해결할 수 있다.
    - 몇 가지 주요 원칙을 염두에 두고 몇가지 구성을 하기만 하면 완전히 처리된 트랜잭션 커밋 건수와 롤백 건수를 얻을 수 있다.
- 개발 리소스
  - 유지 보수할 수 있는 적합한 개발 인력을 찾는 것도 중요하다.
- 지원
  - Github 또는 StackOverflow 등에 활발한 대규모 온라인 커뮤니티가 갖춰져 있는 것도 중요하다.
- 비용
  - 라이센스 비용에 대한 이점이 있다.

---  

## 스프링 배치의 기타 사용 사례  

**ETL(Extract, Transform, Load)**  
스프링 배치의 가장 일반적인 사용 사례이다. 스프링 배치의 청키 기반 처리 및 압도적인 확장 기능은 ETL 워크로드에 자연스럽게 들어맞는다.

**데이터 마이그레이션**  
스프링 배치는 간단한 배치 잡을 기동하고 수행하는 데 많은 코딩이 필요 없으며, 데이터 마이그레이션을 수행할 때 커밋 횟수 측정이나 롤백 기능 등을 제공한다.  

**병렬 처리**  
무어(Moore)의 법칙의 한계에 맞닥뜨리게 되면서, 개발자가 하나의 작업을 더 빨리 처리하는 것이 아니라 더 많은 작업을 병렬로 처리해야 한다는 것을 깨닫게 됐다.  
그 결과 아파치 스파크(Apache Spark), 얀(YARN), 그리드게인(GridGain), 해즐캐스트(Hazlecast) 등과 같은 병렬 처리를 지원하는 많은 프레임워크가 출시됐다.  
스프링 배치는 멀티 코어 또는 멀티 서버에 처리를 분산하는 기능을 아래와 같이 제공하며 애플리케이션에서 사용하는 동일한 객체 및 데이터 소스에 접근하는 기능도 제공한다.  

![병렬 처리 단순화](https://user-images.githubusercontent.com/25560203/130348857-dad51d5a-b79a-439f-ba04-14d1d23dcf00.png)  

**워크로드**  
워크로드를 조정하는 데에도 스프링 배치를 자주 사용한다. 예를 들어, Spring Cloud Data Flow와 Spring Batch를 사용한 **Composed Task** 처리를 이용한다.  

**무중단 처리 또는 상시 데이터 처리**  
스프링 배치는 신뢰할 수 있고 확장 가능한 방식으로 데이터를 청크 단위로 모아서 배치 처리 방식을 가능하게 하는 도구를 제공한다.  

![처리량 향상을 위해 메시지를 배치로 처리](https://user-images.githubusercontent.com/25560203/130349274-3b3f0c1f-74d6-442c-b9b1-91869852db17.png)  

---  

## 스프링 배치 프레임워크

![Spring Batch Layered Architecture](https://docs.spring.io/spring-batch/docs/current/reference/html/images/spring-batch-layers.png)  
(https://docs.spring.io/spring-batch/docs/current/reference/html/images/spring-batch-layers.png)  

스프링 배치는 레이어(Layer) 구조로 조립된 세 개의 티어(Tier)로 이뤄져 있다.  
(애플리케이션 레이어가 최상위에 있는 것이 아니라 다른 두 레이어를 감싸고 있다. 커스텀 리더, 커스텀 라이터와 같은 인프라스트럭처의 일부를 만들기도 하기 때문이다.)